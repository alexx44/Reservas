var LS = LS || {};

LS = (function() {
    var domain = 'ostrovok.ru',
        id = 0,
        debug = false,
        catalogUrl = null,
        timer = false;


    var $q = function(selector, el) {
        if (!el) {el = document;}
        return el.querySelector(selector);
    };

    var $$q = function(selector, el) {
        if (!el) {el = document;}
        return el.querySelectorAll(selector);
    };

    var trim = function(str) {
        return str.replace(/^\s+|\s+$/g, '');
    };

    var innerTXT = function(str) {
        if (document.all) {
            return str.innerText;
        } else{
            return str.textContent;
        }
    };

    var log = function(myvar) {
        if ( ! debug){ return; }
        else if ( ! window.console ){ console = { log: function(){} }; }
        else if (typeof console.log == "undefined"){ console.log = function() {}; }

        console.log(myvar);
    };

    return {

        getTimer: function() {
            return timer;
        },

        detectURL: function() {
            return 0;
        },

        isMainPage: function() {
        	var isMainPage = false;
        	try {
            	isMainPage = (window.location.pathname == '/');
            } catch (e) {}

            return isMainPage;
        },

        isCatalog: function() {
        	var u = document.URL, cat = (u.indexOf(domain + '/rooms/') > -1);
        	if (cat) {
        		id = u.replace(/^http[s]*:\/\//g, '').replace(/^ostrovok.ru\/rooms\//,'').replace(/\/.*?$/,'');
        	}
        	return cat;
        },

        isCart: function() {
			return (document.URL.indexOf('/orders/reserve/') > -1 && $q('.booking-proceed-btn') != null);
        },

        isOrder: function() {
            return (document.URL.indexOf('/orders/success/') > -1 && $q('.bigtopmessage-title-success') != null);
        },

        getProductID: function() {
  			if (!this.isCatalog()) {return '';}

			return id;
        },

        getProductName: function() {
			if (!this.isCatalog()) {return '';}

			var name = '';
			try {
				name = trim(innerTXT($q('.hotel-header .hotel-header-title')).replace(/[\r\n\t]+/g, ' ').replace(/[\s]{2,}/g, ' '));
			} catch (e) {}

			return name;
        },

        getProductBrand: function() {
            return '';
        },

        getProductCategory: function() {
			if (!this.isCatalog()) {return '';}

			var category = '';
			try {
				category = trim(innerTXT($q('.breadcrumbs .breadcrumbs-link')).replace(/[\r\n\t]+/g, ' ').replace(/[\s]{2,}/g, ' '));
				category = category.replace('Посмотреть все отели в ','').replace(/[\s]{2,}/g, ' ');
			} catch (e) {}

			return category;
        },

        getProductDescription: function() {
			if (!this.isCatalog()) {return '';}

			var desc = '';
			try {
				desc = trim(innerTXT($q('.hotel-about-desc .hotel-about-text-text')).replace(/[\r\n\t]+/g, ' ').replace(/[\s]{2,}/g, ' ')).substr(0,1000);
			} catch (e) {}

			return desc;
        },

        getProductPrice: function() {
			if (!this.isCatalog()) {return '';}

			var price = '';
			try {
				price = trim($q('.hotel-metaroom .hotel-metaroom-rate-price .hotel-metaroom-rate-pricevalue').innerHTML.replace(/<div[^>]*>.*?<\/div>/g, ' ').replace(/[^\d]+/g, '').replace('&nbsp;',''));
			} catch (e) {}

			return price;
        },

        getProductOldPrice: function() {
			if (!this.isCatalog()) {return '';}

			var oldprice = '';
			try {
				oldprice = trim(innerTXT($q('.hotel-metaroom .hotel-metaroom-rate-price .hotel-metaroom-rate-pricevalue .hotel-metaroom-rate-strikedprice'))).replace(/[^\d]+/g, '');
			} catch (e) {}

			return oldprice;
        },

        isProductAvailable: function() {
            return 1;
        },

        getProductImage: function() {
			if (!this.isCatalog()) {return '';}

			var image = '';
	        try {
		        image = $q('.hotel-gallery .hotel-gallery-blurimage').src;
	        } catch (e) {}

			return image;
        },

		getCart: function() {
			if (!this.isCart()) {return false;}

			var cartArr = [];
			try {
				if (window.product !== undefined) {
					cartArr.push(
						{
							'ProductId':    window.product,
							'ProductName':  '',
							'ProductUrl':   '',
							'ProductImage': '',
							'ProductPrice': ''
						}
					);
				}
			} catch (e) {}

			return cartArr;
		},

        getOrderID: function() {
			var ret = [];

			try {
				if (this.isOrder()) {
					var apd = window.APRT_DATA || false, oid, op = 0, og = [];
					if (apd) {
						var info = apd['orderInfo'],
							items = apd['purchasedProducts'] || [],
							il = items.length, ii = 0, ip, iq;

						if (info !== undefined) {
							oid = info['id'];

							if (oid) {
								var v = info['totalPrice'] || 0;
								op += parseFloat(v);

								for (; ii < il; ii++) {
									ip = items[ii]['price'] || 0;
									iq = items[ii]['quantity'] || 0;
									og.push([items[ii]['id'], parseInt(iq), parseFloat(ip)]);
								}

								ret.push({
									'oid': oid,
									'op': op,
									'og': JSON.stringify(og),
									'oc': window.currency || ''
								});
							}
						}
					}
				}
			} catch (e) {}

			if (ret.length == 0) {
				ret = '';
				try {
					var expr = "\\/orders\\/success\\/(.*?)\\/",
						regexp = new RegExp(expr, 'i'),
						matches = document.URL.match(regexp);

					if (matches) {
						ret = matches[1];
					}
				} catch (e) {}
			}

            return ret;
        },

        getProductClearUrl: function() {
			if (!this.isCatalog()) {return 0;}
			var cUrl = '';
			try {
				cUrl = window.location.protocol + '//' + window.location.host + window.location.pathname;
			} catch (e) {}
			return cUrl;
        },

        getCurrencyId: function() {
            if (!this.isCatalog()) {return 0;}

            return 1;
        }
    }

}());